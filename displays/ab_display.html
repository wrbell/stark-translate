<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A/B/C Bilingual STT — Stark Road Gospel Hall</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --border: #30363d;
    --text: #e6edf3;
    --text-dim: #8b949e;
    --green: #3fb950;
    --green-dim: #1a3a2a;
    --blue: #58a6ff;
    --blue-dim: #1a2a3a;
    --purple: #bc8cff;
    --purple-dim: #2a1a3a;
    --red: #f85149;
    --yellow: #d29922;
  }

  body {
    font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', monospace;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    user-select: none;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 16px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    font-size: 13px;
    flex-shrink: 0;
  }

  .header .title { font-weight: 600; font-size: 14px; }

  .status {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--red);
    transition: background 0.3s;
  }
  .status-dot.connected { background: var(--green); }

  /* 3-column × 2-row grid */
  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    flex: 1;
    gap: 1px;
    background: var(--border);
    min-height: 0;
  }

  .cell {
    background: var(--bg);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .cell-header {
    padding: 6px 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    flex-shrink: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .cell-header .latency {
    font-weight: 400;
    font-size: 10px;
    color: var(--text-dim);
  }

  .q-green .cell-header { background: var(--green-dim); color: var(--green); }
  .q-blue .cell-header { background: var(--blue-dim); color: var(--blue); }
  .q-purple .cell-header { background: var(--purple-dim); color: var(--purple); }

  .cell-content {
    flex: 1;
    overflow-y: auto;
    padding: 8px 12px;
    font-size: 17px;
    line-height: 1.5;
    scroll-behavior: smooth;
  }

  .cell-content::-webkit-scrollbar { width: 4px; }
  .cell-content::-webkit-scrollbar-track { background: transparent; }
  .cell-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .chunk {
    margin-bottom: 6px;
    opacity: 0;
    animation: fadeIn 0.4s ease forwards;
  }

  .chunk .chunk-num {
    font-size: 9px;
    color: var(--text-dim);
    margin-right: 4px;
  }

  .chunk .confidence-dot {
    display: inline-block;
    width: 6px; height: 6px;
    border-radius: 50%;
    margin-right: 3px;
    vertical-align: middle;
  }

  .conf-good { background: var(--green); }
  .conf-warn { background: var(--yellow); }
  .conf-bad { background: var(--red); }

  .chunk.partial { opacity: 0.5; font-style: italic; }

  /* [P7-P3-6A] Streaming chunk with cursor */
  .chunk.streaming { opacity: 0.85; }

  .streaming-cursor {
    display: inline-block;
    width: 2px;
    height: 0.85em;
    background: var(--text-dim);
    margin-left: 2px;
    vertical-align: text-bottom;
    animation: blink 0.8s step-end infinite;
  }

  @keyframes blink {
    50% { opacity: 0; }
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .footer {
    padding: 5px 12px;
    background: var(--surface);
    border-top: 1px solid var(--border);
    font-size: 10px;
    color: var(--text-dim);
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex-shrink: 0;
  }

  .footer-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 3px 10px;
  }

  .footer .stats {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .footer .stat-val { color: var(--text); font-weight: 600; }
  .footer .green-val { color: var(--green); }
  .footer .blue-val { color: var(--blue); }
  .footer .purple-val { color: var(--purple); }

  .footer .hint { font-size: 9px; color: var(--text-dim); }
  .footer .pct-label { font-size: 9px; color: var(--text-dim); }

  :fullscreen { background: var(--bg); }
  :fullscreen .fs-btn { display: none; }

  .fs-btn {
    position: fixed;
    bottom: 16px;
    right: 16px;
    width: 36px;
    height: 36px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-dim);
    font-size: 18px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 50;
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-appearance: none;
    appearance: none;
  }

  body:hover .fs-btn,
  .fs-btn:focus { opacity: 0.7; }
  .fs-btn:hover { opacity: 1; }
</style>
</head>
<body>

<div class="header">
  <span class="title">A/B/C Bilingual STT — Stark Road Gospel Hall</span>
  <div class="status">
    <span class="status-dot" id="statusDot"></span>
    <span id="statusText">Disconnected</span>
  </div>
</div>

<div class="grid">
  <!-- Row 1: English -->
  <div class="cell q-green">
    <div class="cell-header">
      <span id="labelA">A — English</span>
      <span class="latency" id="latA">—</span>
    </div>
    <div class="cell-content" id="a-en"></div>
  </div>
  <div class="cell q-blue">
    <div class="cell-header">
      <span id="labelB">B — English</span>
      <span class="latency" id="latB">—</span>
    </div>
    <div class="cell-content" id="b-en"></div>
  </div>
  <div class="cell q-purple">
    <div class="cell-header">
      <span>C (Audience) — English</span>
      <span class="latency" id="latC">—</span>
    </div>
    <div class="cell-content" id="c-en"></div>
  </div>

  <!-- Row 2: Spanish -->
  <div class="cell q-green">
    <div class="cell-header">
      <span id="labelAes">A — Español</span>
      <span class="latency" id="latAes">—</span>
    </div>
    <div class="cell-content" id="a-es"></div>
  </div>
  <div class="cell q-blue">
    <div class="cell-header">
      <span id="labelBes">B — Español</span>
      <span class="latency" id="latBes">—</span>
    </div>
    <div class="cell-content" id="b-es"></div>
  </div>
  <div class="cell q-purple">
    <div class="cell-header">
      <span>C (Audience) — Español</span>
      <span class="latency" id="latCes">—</span>
    </div>
    <div class="cell-content" id="c-es"></div>
  </div>
</div>

<div class="footer">
  <div class="footer-row">
    <div class="stats">
      <span>Chunks: <span class="stat-val" id="chunkCount">0</span></span>
      <span>STT: <span class="stat-val" id="avgSTT">—</span></span>
      <span>A: <span class="stat-val green-val" id="avgA">—</span></span>
      <span>B: <span class="stat-val blue-val" id="avgB">—</span></span>
      <span>E2E: <span class="stat-val" id="avgE2E">—</span></span>
      <span>Marian: <span class="stat-val purple-val" id="avgMarian">—</span></span>
      <span>Same: <span class="stat-val" id="sameRate">—</span></span>
    </div>
    <span class="hint">Fullscreen: F11 / Cmd+Shift+F</span>
  </div>
  <div class="footer-row">
    <div class="stats">
      <span class="pct-label">p50:</span>
      <span>STT <span class="stat-val" id="p50STT">—</span></span>
      <span>A <span class="stat-val green-val" id="p50A">—</span></span>
      <span>B <span class="stat-val blue-val" id="p50B">—</span></span>
      <span>M <span class="stat-val purple-val" id="p50Marian">—</span></span>
      <span>E2E <span class="stat-val" id="p50E2E">—</span></span>
      <span class="pct-label" style="margin-left:6px">p95:</span>
      <span>STT <span class="stat-val" id="p95STT">—</span></span>
      <span>A <span class="stat-val green-val" id="p95A">—</span></span>
      <span>B <span class="stat-val blue-val" id="p95B">—</span></span>
      <span>M <span class="stat-val purple-val" id="p95Marian">—</span></span>
      <span>E2E <span class="stat-val" id="p95E2E">—</span></span>
      <span class="pct-label" style="margin-left:6px">t/s:</span>
      <span>A <span class="stat-val green-val" id="tpsA">—</span></span>
      <span>B <span class="stat-val blue-val" id="tpsB">—</span></span>
    </div>
  </div>
</div>

<button class="fs-btn" id="fsBtn" aria-label="Toggle fullscreen" title="Fullscreen">&#x26F6;</button>

<script>
(function() {
  const wsHost = location.hostname || 'localhost';
  const WS_URL = 'ws://' + wsHost + ':8765';
  const RECONNECT_MS = 2000;

  const $ = id => document.getElementById(id);
  const statusDot = $('statusDot');
  const statusText = $('statusText');
  const panels = {
    'a-en': $('a-en'), 'a-es': $('a-es'),
    'b-en': $('b-en'), 'b-es': $('b-es'),
    'c-en': $('c-en'), 'c-es': $('c-es'),
  };

  // Stats
  let chunks = 0;
  let sumA = 0, sumB = 0, sumSTT = 0, sumE2E = 0;
  let sameCount = 0;
  let sumTpsA = 0, sumTpsB = 0, tpsCountA = 0, tpsCountB = 0;
  let sumMarian = 0, marianCount = 0, latenciesMarian = [];
  let latenciesSTT = [], latenciesA = [], latenciesB = [], latenciesE2E = [];

  // Track model names — auto-detect from first data
  let modelA = null, modelB = null;
  let hasAB = false;  // true when 12B is running

  // Note: "ass" (donkey), "damn" (damnation), "whore" (KJV) removed — legitimate biblical terms
  const BLOCKED_WORDS = /\b(asshole|bitch|bastard|crap|cunt|dick|fuck|fucking|motherfucker|piss|shit|slut)\b/gi;
  function filterText(text) {
    return text ? text.replace(BLOCKED_WORDS, m => '*'.repeat(m.length)) : '';
  }

  function percentile(arr, p) {
    if (arr.length === 0) return 0;
    const sorted = [...arr].sort((a, b) => a - b);
    const idx = Math.ceil((p / 100) * sorted.length) - 1;
    return sorted[Math.max(0, idx)];
  }

  function fmtMs(ms) { return ms > 0 ? ms.toFixed(0) + 'ms' : '—'; }

  function confidenceClass(conf) {
    if (conf === undefined || conf === null) return '';
    if (conf >= 0.7) return 'conf-good';
    if (conf >= 0.4) return 'conf-warn';
    return 'conf-bad';
  }

  function updateLabels() {
    if (hasAB) {
      $('labelA').textContent = 'A (Gemma 4B) — English';
      $('labelAes').textContent = 'A (Gemma 4B) — Español';
      $('labelB').textContent = 'B (Gemma 12B) — English';
      $('labelBes').textContent = 'B (Gemma 12B) — Español';
    } else {
      $('labelA').textContent = 'A (Gemma 4B) — English';
      $('labelAes').textContent = 'A (Gemma 4B) — Español';
      $('labelB').textContent = 'B (MarianMT) — English';
      $('labelBes').textContent = 'B (MarianMT) — Español';
    }
  }

  // Track last MarianMT partial per utterance for column B (non-AB mode)
  let lastMarianPartial = {};

  function connect() {
    const ws = new WebSocket(WS_URL);

    ws.onopen = () => {
      statusDot.classList.add('connected');
      statusText.textContent = 'Live';
    };

    ws.onclose = () => {
      statusDot.classList.remove('connected');
      statusText.textContent = 'Reconnecting...';
      setTimeout(connect, RECONNECT_MS);
    };

    ws.onerror = () => ws.close();

    ws.onmessage = (evt) => {
      const data = JSON.parse(evt.data);

      // [P7-P3-6A] Handle streaming translation messages
      if (data.type === 'translation_start') {
        // STT completed — show English in A column with streaming placeholder
        const en = filterText(data.english || '');
        const conf = data.stt_confidence;
        const confDot = conf !== undefined
          ? '<span class="confidence-dot ' + confidenceClass(conf) + '"></span>'
          : '';
        // Show English in A column
        if (en) upsertChunk(panels['a-en'], 'stream-' + data.chunk_id, en, confDot, false, false);
        // Create streaming placeholder in A Spanish column
        upsertChunk(panels['a-es'], 'stream-' + data.chunk_id, '', '', false, true);
        // Show English in C column too
        if (en) upsertChunk(panels['c-en'], 'stream-' + data.chunk_id, en, confDot, false, false);
        upsertChunk(panels['c-es'], 'stream-' + data.chunk_id, '', '', false, true);
        return;
      }

      if (data.type === 'translation_stream') {
        // Progressive Spanish text update for A column
        const partialEs = filterText(data.partial_spanish_a || '');
        upsertChunk(panels['a-es'], 'stream-' + data.chunk_id, partialEs, '', false, true);
        upsertChunk(panels['c-es'], 'stream-' + data.chunk_id, partialEs, '', false, true);
        return;
      }

      if (data.type !== 'translation') return;

      const stage = data.stage || 'complete';
      const conf = data.stt_confidence;
      const confDot = conf !== undefined
        ? '<span class="confidence-dot ' + confidenceClass(conf) + '"></span>'
        : '';

      const isPartial = stage === 'partial';

      if (isPartial) {
        // --- PARTIAL (MarianMT fast translation) ---
        const en = filterText(data.english || '');
        const es = filterText(data.spanish_a || '');

        // Column C (audience): show italic partial
        if (en) upsertChunk(panels['c-en'], 'p-' + data.chunk_id, en, confDot, true);
        if (es) upsertChunk(panels['c-es'], 'p-' + data.chunk_id, es, '', true);

        // Column B (MarianMT in non-AB mode): show italic partial
        if (!hasAB) {
          if (en) upsertChunk(panels['b-en'], 'p-' + data.chunk_id, en, confDot, true);
          if (es) {
            upsertChunk(panels['b-es'], 'p-' + data.chunk_id, es, '', true);
            lastMarianPartial[data.chunk_id] = es;
          }
        }

        // Column A: show English partial only (no Gemma translation yet)
        if (en) upsertChunk(panels['a-en'], 'p-' + data.chunk_id, en, confDot, true);

        // Latency for partial
        if (data.latency_a_ms) {
          $('latB').textContent = fmtMs(data.latency_a_ms);
          $('latBes').textContent = fmtMs(data.latency_a_ms);
          $('latC').textContent = fmtMs((data.stt_latency_ms || 0) + data.latency_a_ms);
          $('latCes').textContent = fmtMs((data.stt_latency_ms || 0) + data.latency_a_ms);
        }

        // MarianMT latency tracking (partials only — Marian doesn't run on finals)
        const marianMs = data.marian_pt_ms || data.latency_a_ms || 0;
        if (marianMs > 0) {
          sumMarian += marianMs;
          marianCount++;
          latenciesMarian.push(marianMs);
          $('avgMarian').textContent = fmtMs(sumMarian / marianCount);
          $('p50Marian').textContent = fmtMs(percentile(latenciesMarian, 50));
          $('p95Marian').textContent = fmtMs(percentile(latenciesMarian, 95));
        }

        return;
      }

      // --- FINAL (stt / translation_a / complete) ---

      // Detect A/B mode on first complete message
      if (stage === 'complete' && data.spanish_b && !hasAB) {
        hasAB = true;
        updateLabels();
      }

      // Remove partial and streaming rows from all columns
      const pid = 'p-' + data.chunk_id;
      const sid = 'stream-' + data.chunk_id;
      Object.values(panels).forEach(p => { removeChunk(p, pid); removeChunk(p, sid); });

      const en = filterText(data.english || '');
      const esA = filterText(data.spanish_a || '');
      const esB = filterText(data.spanish_b || '');

      // Column A (Gemma 4B): always shows Gemma translation
      if (en) upsertChunk(panels['a-en'], data.chunk_id, en, confDot, false);
      if (esA) upsertChunk(panels['a-es'], data.chunk_id, esA, '', false);

      if (hasAB) {
        // AB mode: Column B = Gemma 12B
        if (en) upsertChunk(panels['b-en'], data.chunk_id, en, confDot, false);
        if (esB) upsertChunk(panels['b-es'], data.chunk_id, esB, '', false);
      } else {
        // Non-AB mode: Column B = MarianMT (keep the last partial as the final)
        if (en) upsertChunk(panels['b-en'], data.chunk_id, en, confDot, false);
        const marianFinal = lastMarianPartial[data.chunk_id] || '';
        if (marianFinal) upsertChunk(panels['b-es'], data.chunk_id, marianFinal, '', false);
        delete lastMarianPartial[data.chunk_id];
      }

      // Column C (audience output): show final Gemma (replaces italic partial)
      if (en) upsertChunk(panels['c-en'], data.chunk_id, en, confDot, false);
      if (esA) upsertChunk(panels['c-es'], data.chunk_id, esA, '', false);

      // Latency updates
      const latSTT = data.stt_latency_ms || 0;
      if (data.latency_a_ms) {
        $('latA').textContent = fmtMs(data.latency_a_ms);
        $('latAes').textContent = fmtMs(data.latency_a_ms);
      }
      if (data.latency_b_ms && hasAB) {
        $('latB').textContent = fmtMs(data.latency_b_ms);
        $('latBes').textContent = fmtMs(data.latency_b_ms);
      }
      if (data.e2e_latency_ms) {
        $('latC').textContent = fmtMs(data.e2e_latency_ms);
        $('latCes').textContent = fmtMs(data.e2e_latency_ms);
      }

      // Stats on complete only
      if (stage === 'complete') {
        const latA = data.latency_a_ms || 0;
        const latB = data.latency_b_ms || 0;
        const e2e = data.e2e_latency_ms || (latSTT + Math.max(latA, latB));

        chunks++;
        sumA += latA;
        sumB += latB;
        sumSTT += latSTT;
        sumE2E += e2e;
        if (data.spanish_a === data.spanish_b && data.spanish_b) sameCount++;

        latenciesSTT.push(latSTT);
        latenciesA.push(latA);
        if (latB > 0) latenciesB.push(latB);
        latenciesE2E.push(e2e);

        const tpsA = data.tps_a || 0;
        const tpsB = data.tps_b || 0;
        if (tpsA > 0) { sumTpsA += tpsA; tpsCountA++; }
        if (tpsB > 0) { sumTpsB += tpsB; tpsCountB++; }

        $('chunkCount').textContent = chunks;
        $('avgA').textContent = fmtMs(sumA / chunks);
        $('avgB').textContent = latenciesB.length > 0 ? fmtMs(sumB / latenciesB.length) : '—';
        $('avgSTT').textContent = fmtMs(sumSTT / chunks);
        $('avgE2E').textContent = fmtMs(sumE2E / chunks);
        $('sameRate').textContent = hasAB
          ? ((sameCount / chunks) * 100).toFixed(0) + '%' : '—';

        $('p50STT').textContent = fmtMs(percentile(latenciesSTT, 50));
        $('p50A').textContent = fmtMs(percentile(latenciesA, 50));
        $('p50B').textContent = latenciesB.length > 0 ? fmtMs(percentile(latenciesB, 50)) : '—';
        $('p50E2E').textContent = fmtMs(percentile(latenciesE2E, 50));
        $('p95STT').textContent = fmtMs(percentile(latenciesSTT, 95));
        $('p95A').textContent = fmtMs(percentile(latenciesA, 95));
        $('p95B').textContent = latenciesB.length > 0 ? fmtMs(percentile(latenciesB, 95)) : '—';
        $('p95E2E').textContent = fmtMs(percentile(latenciesE2E, 95));

        $('tpsA').textContent = tpsCountA > 0 ? (sumTpsA / tpsCountA).toFixed(0) : '—';
        $('tpsB').textContent = tpsCountB > 0 ? (sumTpsB / tpsCountB).toFixed(0) : '—';
      }
    };
  }

  function upsertChunk(panel, id, text, prefix, isPartial, isStreaming) {
    const domId = panel.id + '-chunk-' + id;
    let div = document.getElementById(domId);
    if (!div) {
      div = document.createElement('div');
      div.id = domId;
      div.className = 'chunk';
      panel.appendChild(div);
    }
    div.className = isStreaming ? 'chunk streaming' : isPartial ? 'chunk partial' : 'chunk';
    const isTemporary = typeof id === 'string' && (id.startsWith('p-') || id.startsWith('stream-'));
    const label = isTemporary ? '' : '<span class="chunk-num">#' + id + '</span>';
    // [P7-P3-6A] Add streaming cursor for actively streaming text
    const cursor = isStreaming ? '<span class="streaming-cursor"></span>' : '';
    div.innerHTML = (prefix || '') + label + escapeHtml(text) + cursor;
    panel.scrollTop = panel.scrollHeight;
  }

  function removeChunk(panel, id) {
    const domId = panel.id + '-chunk-' + id;
    const div = document.getElementById(domId);
    if (div) div.remove();
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str || '';
    return div.innerHTML;
  }

  function toggleFullscreen() {
    if (document.fullscreenElement) document.exitFullscreen();
    else document.documentElement.requestFullscreen();
  }

  document.getElementById('fsBtn').addEventListener('click', toggleFullscreen);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'F11' || (e.metaKey && e.shiftKey && e.key === 'f')) {
      e.preventDefault();
      toggleFullscreen();
    }
  });

  updateLabels();
  connect();
})();
</script>
</body>
</html>
